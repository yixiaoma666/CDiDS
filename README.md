# Aim

在具有Concept Drift下的Streaming Data中进行Anomaly Detection

在Emerge New Class的Concept Drift下的Streaming Data中进行Anomaly Detection

# 记录

数据可以单个或多个进入

CD的分类方式

![image-20221020230350423](D:\MYX\CDiDS\README_png\image-20221020230350423.png)

CD的本质在于底层分布的变化，大致分为两类，变化为何与如何变化

ADiDSwCD问题可形式化为

对于分布流$\{P_1,\dots,P_n,\dots\}$。如果$P_i\neq P_{i+1}$，则我们称在$i$处发生了CD。若数据流$\{x_1,\dots,x_n\dots\}$中$x_i\precnsim \mathcal{P}_i$或$\neg (x_i\precsim\mathcal{P}_i)$，则称$x_i$是一个异常点。

异常点的定义为：An outlier is an observation which deviates so much from the other observations as to arouse suspicions that it was generated by a different mechanism.

何为 different mechanism，即分布$\mathcal{P}$。对于数据$x_i=0,i\in[1,10]\cup[12,20],x_{11}=1$，我们很容易知道$x_{11}$是异常，但如果$\mathcal{P}_i$已知，且告诉我们$\mathcal{P}_{i}=\delta(x),x=0,i\in[1,10]\cup[12,20],\mathcal{P}_{11}=\delta(x),x=1$，那么$x_{11}$显然不是异常。

那么为何在未告知分布时会认为$x_{11}$是异常？因为我们假设数据是 i.i.d. 的，即基于独立同分布的。而基于的分布并未给出，而是我们是通过之前观察到的数据自认为生成的分布。

我们假设abrupt的CD不常发生，“不常发生”的定义为发生此类CD的频率不大于某个阈值，gradual的CD不会很快，“不会很快”的定义为相邻的两个分布相似度不低于某个阈值。

## 点可能采样自与点可能不采样自的定义

给定分布$\mathcal{P}$以及他的PDF$f(x)$与点$x_0$，以及置信度$\alpha$，定义“$x_0$以置信度$\alpha$采样自$\mathcal{P}$”为：

定义：对于区间$A=\bigcup\arg\max_{x\in A\subseteq \mathcal{X}}\min f(x)$，且满足$\int_Af(x)\mathrm{d}x\ge 1-\alpha$，若$x_0\in A$，则称$x_0$以置信度$\alpha$采样自$\mathcal{P}$，记为$x_0\precsim_{\alpha}\mathcal{P}$。

类似的我们可以定义“$x_0$以置信度$\beta$不采样自$\mathcal{P}$”为：

定义：对于区间$B=\bigcup\arg\min_{x\in B\subseteq \mathcal{X}}\max f(x)$，且满足$\int_Bf(x)\mathrm{d}x\le 1-\beta$，若$x_0\in B$，则称$x_0$以置信度$\beta$不采样自$\mathcal{P}$，记为$x_0\precnsim_{\beta}\mathcal{P}$。

若$x\precsim_\alpha\mathcal{P}\Leftrightarrow x\precnsim_\beta P$，当且仅当$\alpha+\beta\le1$。

若$\mathcal{P}_1=\mathcal{P}_2$，则$x\precsim_\alpha\mathcal{P}_1\Leftrightarrow x\precsim_\alpha\mathcal{P}_2,x\precnsim_\alpha\mathcal{P}_1\Leftrightarrow x\precnsim_\alpha\mathcal{P}_2$。

若$\mathcal{P}_1\neq\mathcal{P}_2$，则$x\precsim_\alpha\mathcal{P}_1\nLeftrightarrow x\precnsim_\alpha\mathcal{P}_2,x\precnsim_\alpha\mathcal{P}_1\nLeftrightarrow x\precsim_\alpha\mathcal{P}_2$。

$$
x\in[-0.253,0.253],x\precsim_{0.8}\mathcal{P}
$$

$$
x\in\left(-\infin,-1.28\right]\cup\left[1.28,+\infin\right),x\precnsim_{0.8}\mathcal{P}
$$

![image-20221021220005388](D:\MYX\CDiDS\README_png\image-20221021220005388.png)

由此可见，$x\precsim_\alpha\mathcal{P}$与$x\precnsim_\alpha P$二者并非对立事件，甚至在$\alpha<0.5$时，二者并非互斥事件。

之后在不强调置信度$\alpha$时，可将$x\precsim_\alpha\mathcal{P}$简记为$x\precsim\mathcal{P}$。

### 可能同分布和可能不同分布的定义

由上节可知道，对于给定的点$x$和分布$\mathcal{P}$，则存在$\alpha$使得$x\precsim_\alpha\mathcal{P},x\precnsim_{1-\alpha}\mathcal{P}$，若$\alpha>\alpha_0$，则有$x\precsim_{\alpha_0}\mathcal{P}$，若$1-\alpha>1-\alpha_0$，则有$x\precnsim_{1-\alpha_0}\mathcal{P}$。下给出可能同分布的定义。

定义：对于给定的分布$\mathcal{P}_0$，则$\mathcal{P}$以$\alpha$可能同分布于$\mathcal{P}_0$的定义为：从$\mathcal{P}$中充分采样$\{x_1,\dots,x_n\}$，则存在$\alpha_1,\dots,\alpha_n$使得$x_1\precsim_{\alpha_1}\mathcal{P_0},\dots,x_n\precsim_{\alpha_n}\mathcal{P_0}$，若$\frac{1}{n}\sum_{i=1}^n\alpha_i\ge\alpha$，则称$\mathcal{P}$以$\alpha$可能同分布于$\mathcal{P}_0$，记为$\mathcal{P}\sim_\alpha\mathcal{P_0}$。

类似的可以给出可能不同分布的定义。

定义：对于给定的分布$\mathcal{P}_0$，则$\mathcal{P}$以$\alpha$可能不同分布于$\mathcal{P}_0$的定义为：从$\mathcal{P}$中充分采样$\{x_1,\dots,x_n\}$，则存在$\alpha_1,\dots,\alpha_n$使得$x_1\precnsim_{\alpha_1}\mathcal{P_0},\dots,x_n\precnsim_{\alpha_n}\mathcal{P_0}$，若$\frac{1}{n}\sum_{i=1}^n\alpha_i\ge\alpha$，则称$\mathcal{P}$以$\alpha$可能不同分布于$\mathcal{P}_0$，记为$\mathcal{P}\nsim_\alpha\mathcal{P_0}$。

与上面“点可能采样自”和“点可能不采样自”类似地，$\mathcal{P}\sim_\alpha\mathcal{P_0}$和$\mathcal{P}\nsim_\alpha\mathcal{P_0}$并非互斥事件。

##  B Step原理

现给分布流$\{\dots,\mathcal{P}_m,\mathcal{P}_{m+1},\dots\}$，对于给定的置信度$\alpha\gg0.5$，我们假设在$m$处发生了CD，即$\mathcal{P}_{m+1}\ne\mathcal{P}_m$。我们给假设$H_0:\mathcal{P}_{m+1}\sim_\alpha\mathcal{P_m}$与备择假设$H_1:\neg (\mathcal{P}_{m+1}\sim_\alpha\mathcal{P_m})$。根据上述“可能同分布”的定义，我们需要在$\mathcal{P}_{m+1}$中充分采样，但是我们只有$x_{i+1}$这一个点，因此这无法做到。由于我们假设了$\mathcal{P}_{m+1}\sim_\alpha\mathcal{P_m}$，因此我们可以用$\mathcal{P}_m$中的采样点来代替从$\mathcal{P}_{m+1}$中的样本点。这里给定“充分采样”中的充分数量$L$，即一个滑窗长度，此滑窗是定长且连续的，且时刻包括最新进入的点。若使用滑窗中的点使得可以拒绝$H_0$，那么我们即可认为需要一个新的检测器。如果不能拒绝，则把$x_{m+2}$置入滑窗并把最旧的点移除。

这里我们根据“CD不常发生”的假设，认为在一定限度内$\mathcal{P}_{m+1}=\mathcal{P}_{m+2}=\dots$。

### B Step

在实际操作中，由于$\mathcal{P}_i$无法真实给出，因此我们使用给定异常分数阈值的异常率判断是否需要生成新的检测器。

此方法的原理是，在 IDK中，对于给定的$x$和$\mathcal{P}$，$x$的异常分数方差很小，若$x$为正常点，则为一个大于0的常数，若$x$为异常点，则为0。

此时我们只拒绝了$\mathcal{P}_{m+1}\sim_\alpha\mathcal{P_m}$，但并未接受$\mathcal{P}_{m+1}\nsim_\alpha\mathcal{P_m}$，因此我们进行 D Step。

## D Step原理

与B Step类似地，我们给出原假设$H_0:\neg (\mathcal{P}_{m+1}\nsim_\alpha\mathcal{P_m})$，与备择假设$H_1:\mathcal{P}_{m+1}\nsim_\alpha\mathcal{P_m}$。若滑窗中的点可以拒绝$H_0$，则认为旧检测器需要被删除。

### D Step

同样地，我们使用给定异常分数阈值的异常率判断是否需要删除旧的检测器。

## 如何定义阈值？

选择阈值使得用于生成IDK的点的异常分数类内方差之和最大。

## 一些重要的细节

在B Step中，我们使用滑窗中的点来拒绝$H_0$，但我们只使用那些被识别为异常的点用以生成新的模型，而并非使用滑窗中所有的点，具体原因之后会阐述。

## 设置B Step和D Step的意义

传统的CD框架为

![image-20221022135240404](D:\MYX\CDiDS\README_png\image-20221022135240404.png)

而在以往的其他工作中，大多是在关注“Is Concept Drift”环节，而较为忽略的“Update Learning Model”环节。这个环节有如下几个问题：

1. 何时构造新的模型？
2. 使用哪些样本进行构造新的模型？
3. 旧的模型如何处理？

问题1：已经有大量工作研究，并且视角很多很新颖。

问题2：我们这里使用那些被判别为异常点的样本来构造新的模型。

问题3：我们认为旧的模型仍有一定的参考价值，这里的“一定”意味着，我们将在适合的阶段丢掉该旧模型。此处的“合适阶段”是一种基于数据和模型关系的方法，而并非传统的基于模型数量的遗忘机制。传统的遗忘机制我统称为$k$-memory机制

- $k=0$，全遗忘机制，即只保留一个模型。在生成新的模型后，旧的模型将直接被抛弃。
- $k=+\infty$，无遗忘机制，即旧的模型永远参与检测或预测，或是将新的模型直接融入旧的模型中。
- $k$为有限正整数，即保留不超过$k$个模型，在第$k+1$个模型被生成后，最旧的那个将被遗忘。

![image-20221023235052462](D:\MYX\CDiDS\README_png\image-20221023235052462.png)

对应着不同的$k$，各种机制也有其相应的弊端。

## 我们的机制

我们的机制与前文所述的B&D Step相似，使用两阶段来控制模型的 birth 和 death。

基本思路以朴素的语言叙述如下：

- 如果现有的点并非“采样自所有已有的模型”，则产生一个新的模型；
- 如果现有的点“不采样自某已有的模型”，则将这个模型删除。

此处使用IDK，将使用数据点生成IDK，用以估计分布，同时作为检测的模型。

算法流程图如下：



## 为什么这样做？

### 为什么使用异常点构造新模型而非所有点？

如果使用所有点，DS问题具有 one-pass 约束。如果在$i+1$处识别到发生了CD

- 如果使用$i+1$之前的点来生成模型，而CD的发生是不可预料的，则我们需要记录$i+1$之前所有的点以供未来可能发生的CD的模型生成，这是内存所不允许的。
- 如果仅记录有限个点，则会在 gradual drift 中产生问题。例如$\mathcal{P}_i$为恒0分布，$\mathcal{P}_{i+m}$为恒1分布，而$P_{i+1},\dots,P_{i+m-1}$为$\{0,1\}$的随机分布，此时若在检测到CD时，使用之前保存的有限个（其中包含0点）点来生成新模型$\mathcal{P}_{new}$，则这里的$\mathcal{P}_{new}$为${0,1}$随机分布，之后进行至$\mathcal{P}_{i+m}$时，此时$\mathcal{P}_{i}$已被移除，此时$0\precnsim\mathcal{P}_{i+1}$，理应被识别为异常点，但由于0在$\mathcal{P}_{new}$中仍为正常点，则会导致检测效果降低。我称这种现象为“不完全的遗忘”。
- 如果使用$i+1$之后的点来生成模型，由于IDK需要数据点较大，则会导致Delay过高，即报告CD后无法及时的生成新模型。

但如果仅使用异常点构造新模型，由于异常点的数量较少，则内存是可以允许的，而且在报告CD时即可立即生成新模型。

### 为什么使用多个模型而非一个模型？

假设在$i+1$处发生了CD，即$\mathcal{P}_i\ne\mathcal{P}_{i+1}$，根据上述性质，$x_{i+1}\precsim\mathcal{P}_{i+1}\nRightarrow x_{i+1}\precnsim\mathcal{P}_i$。因此我们没有理由在生成新模型后立即将旧模型删除。

### 为什么使用遗忘机制而非保存所有的模型？

由于是异常检测问题，例如$\mathcal{P}_i$为恒0分布，$\mathcal{P}_{i+1}$为恒1分布，在$i+1$处发生CD后，此时$0\precnsim\mathcal{P}_{i+1}$，但若保存所有的模型，则0仍会被$\mathcal{P}_i$识别为正常点而导致检测效果降低。

### 能否处理各种各样的CD？

#### Type 分类

![image-20221022152900158](D:\MYX\CDiDS\README_png\image-20221022152900158.png)

- b 这并非发生了CD，我们的方法也并未将其判断为CD。
- c 我们将会产生两个新的模型，并将旧的模型遗忘。
- d 此方法无法检测到某类数量的变化，因为这在我们的分类器中无法汇报为异常。
- e 我们将产生一个新的模型。
- f 我们将产生一个新的模型。

#### Speed 分类

![image-20221022153427923](D:\MYX\CDiDS\README_png\image-20221022153427923.png)

- a 我们将产生一个新的模型，并将很快的将旧模型遗忘。
- b 我们在$\mathcal{P}_i$时把$C_2$汇报为异常，在混合分布时产生一个模型$\mathcal{P}_{temp}$，并不会把$C_1$与$C_2$中任何一种汇报为异常，之后在$\mathcal{P}_{i+1}$时产生新的模型，并把$\mathcal{P}_{temp}$删除，此时把$C_1$汇报为异常。
- c 连续性的CD无法处理，我们将其离散化处理，认为频繁的发生了 a，此时产生新模型的产生和旧模型的遗忘将频繁发生，直至完全转变。
- d 若$C_2$数量较少，以至不足以被我们检测为CD，则均将$C_2$识别为异常，若$C_2$被我们检测为CD，则就是两阶段的a。


# To Do List

对于定义存在性的证明以及性质的证明。

流程图的绘制

# Motivation and Contribution

1. 我们给出了关于 Anomaly detection in data stream with concept drift (ADiDSwCD) 的具体定义。
2. 现有的工作大多聚焦于检测 CD，而仅使用较为朴素的方法去更新模型，因此我们提出了一种 paradigm 以处理更新模型的问题。此 paradigm 使用了一种全新的遗忘机制，有别于传统的k-memory。
   - Isolation Forest ASD 使用滑动窗口（滑窗长度为需要调的参），使用 IF 异常分数检测异常（分数阈值为参数），若异常率高于某个值（此为参数），则使用当前窗口的数据生成一个新的检测器，并将旧的检测器丢掉。因此该方法是0-memory的。
3. 我们的 paradigm 可以使用任何检测器，在这里我们使用 IDK 作为异常检测器。

# 实验

## 数据集

IForestASD：Http，Smtp，ForestCover，Shuttle

## 评价指标

AUC